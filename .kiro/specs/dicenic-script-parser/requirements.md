# 需求文档

## 介绍

Dicenic是一个专为游戏应用设计的简单脚本语言解析器，主要用于实现牌堆、自定义表达式、骰娘个性化设置等模块的安全自定义功能。该语言支持变量操作、运算符、流程控制，并具有特殊的游戏相关变量系统。解析器将最后出现的变量或字面量隐式转换为字符串作为结果输出。

## 需求

### 需求 1

**用户故事：** 作为开发者，我希望能够解析Dicenic脚本中的不同变量类型，以便支持数字、字符串和掷骰表达式的处理。

#### 验收标准

1. WHEN 解析器遇到整数或小数时 THEN 系统 SHALL 正确识别并存储为数字类型
2. WHEN 解析器遇到用""或''包裹的文本时 THEN 系统 SHALL 正确识别并存储为字符串类型
3. WHEN 解析器遇到包含'd'运算符的表达式时 THEN 系统 SHALL 正确识别为掷骰表达式且只支持整数
4. WHEN 进行布尔判断时 THEN 系统 SHALL 将0和空字符串视为false，其余值视为true

### 需求 2

**用户故事：** 作为开发者，我希望能够处理特殊变量命名系统，以便访问角色卡、角色信息、系统信息和骰娘信息。

#### 验收标准

1. WHEN 解析器遇到$a前缀的变量时 THEN 系统 SHALL 识别为角色卡属性变量且支持读写操作
2. WHEN 解析器遇到$r前缀的变量时 THEN 系统 SHALL 识别为角色信息变量且仅支持只读操作
3. WHEN 解析器遇到$s前缀的变量时 THEN 系统 SHALL 识别为系统信息变量且仅支持只读操作
4. WHEN 解析器遇到$d前缀的变量时 THEN 系统 SHALL 识别为骰娘信息变量且支持读写操作
5. WHEN $r或$s类型变量未定义时 THEN 系统 SHALL 默认返回0或空字符串

### 需求 3

**用户故事：** 作为开发者，我希望能够处理各种运算符操作，以便支持数学运算、比较运算和逻辑运算。

#### 验收标准

1. WHEN 解析器遇到算术运算符(+,-,*,/,%)时 THEN 系统 SHALL 正确执行数学运算
2. WHEN 解析器遇到赋值运算符(+=,-=,*=,/=,%=)时 THEN 系统 SHALL 正确执行复合赋值操作
3. WHEN 解析器遇到比较运算符(==,>,<,!=,>=,<=)时 THEN 系统 SHALL 正确执行比较操作并返回布尔结果
4. WHEN 解析器遇到逻辑运算符(&&,||,!)时 THEN 系统 SHALL 正确执行逻辑运算
5. WHEN 不同类型进行运算时 THEN 系统 SHALL 尝试隐式类型转换，转换失败时使用目标类型默认值

### 需求 4

**用户故事：** 作为开发者，我希望能够支持流程控制语句，以便实现条件分支和循环逻辑。

#### 验收标准

1. WHEN 解析器遇到if-else语句时 THEN 系统 SHALL 根据条件正确执行相应分支
2. WHEN 解析器遇到三目运算符时 THEN 系统 SHALL 正确执行条件表达式
3. WHEN 解析器遇到while循环时 THEN 系统 SHALL 根据条件正确执行循环体
4. WHEN 流程控制中包含变量操作时 THEN 系统 SHALL 正确更新变量状态

### 需求 5

**用户故事：** 作为开发者，我希望解析器能够正确处理脚本执行结果，以便将最后的变量或字面量转换为字符串输出。

#### 验收标准

1. WHEN 脚本执行完成时 THEN 系统 SHALL 获取最后出现的变量或字面量
2. WHEN 获取到最后的值时 THEN 系统 SHALL 将其隐式转换为字符串
3. WHEN 转换完成时 THEN 系统 SHALL 将结果作为脚本执行的最终输出
4. WHEN 脚本中包含字符串插值时 THEN 系统 SHALL 正确解析并替换变量值

### 需求 6

**用户故事：** 作为开发者，我希望解析器具有良好的错误处理机制，以便在遇到语法错误或运行时错误时提供有用的错误信息。

#### 验收标准

1. WHEN 解析器遇到语法错误时 THEN 系统 SHALL 抛出包含位置信息的语法错误
2. WHEN 解析器遇到未定义变量时 THEN 系统 SHALL 根据变量类型提供默认值或抛出错误
3. WHEN 解析器遇到类型转换失败时 THEN 系统 SHALL 使用目标类型的默认值并记录警告
4. WHEN 解析器遇到运行时错误时 THEN 系统 SHALL 提供清晰的错误信息和上下文